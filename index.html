<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEng</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #2c3e50; color: #ecf0f1; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .quiz-container { background-color: #34495e; border-radius: 10px; padding: 70px 30px 30px 30px; width: 100%; max-width: 800px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); position: relative; }
        .question-header { border-bottom: 2px solid #7f8c8d; padding-bottom: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .sentence { font-size: 1.4em; font-style: italic; margin-bottom: 0; flex-grow: 1; }
        .prompt { font-size: 1.2em; font-weight: bold; margin-top: 10px; }
        .options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option { background-color: #7f8c8d; border: 2px solid transparent; border-radius: 5px; padding: 15px; cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; }
        .option:hover { background-color: #95a5a6; }
        .option.correct { background-color: #27ae60; color: white; border-color: #2ecc71; }
        .option.incorrect { background-color: #c0392b; color: white; border-color: #e74c3c; }
        .option-letter { font-weight: bold; margin-right: 15px; background-color: rgba(0,0,0,0.2); border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .controls { margin-top: 30px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        button { background: none; border: 1px solid #bdc3c7; color: #ecf0f1; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease-in-out; }
        button:hover { background: #7f8c8d; }
        .stats { position: absolute; top: 15px; right: 25px; font-size: 0.9em; color: #bdc3c7; text-align: right; }
        #speak-btn { font-size: 1.5em; cursor: pointer; user-select: none; }
        .srs-btn { color: white; border: none; padding: 12px 20px; border-radius: 5px; font-size: 1em; cursor: pointer; transition: opacity 0.2s; }
        .srs-btn:hover { opacity: 0.9; }
        .status-label { position: absolute; top: 15px; left: 25px; font-size: 1.1em; font-weight: bold; text-transform: uppercase; }
        .status-new { color: #f1c40f; }
        .status-review { color: #e67e22; }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div id="question-status" class="status-label"></div>
        <div id="stats" class="stats"></div>
        <div id="question-area">
            <div class="question-header">
                <p id="sentence" class="sentence"></p>
                <span id="speak-btn" title="Tekrar Dinle">ðŸ”Š</span>
            </div>
            <p id="prompt" class="prompt"></p>
            <div id="options-container" class="options-container"></div>
        </div>
        <div class="controls">
            <button id="reset-btn">Ä°lerlemeyi SÄ±fÄ±rla</button>
            <button id="download-progress-btn">Ä°lerlemeyi Ä°ndir</button>
            <input type="file" id="upload-progress-input" style="display:none;" />
            <button id="upload-progress-btn">Ä°lerlemeyi YÃ¼kle</button>
            <div id="srs-controls" style="display: none; gap: 10px;">
                <button class="srs-btn" id="srs-again" style="background-color: #c0392b;">Tekrar</button>
                <button class="srs-btn" id="srs-hard" style="background-color: #e67e22;">Zor</button>
                <button class="srs-btn" id="srs-good" style="background-color: #3498db;">Ä°yi</button>
                <button class="srs-btn" id="srs-easy" style="background-color: #27ae60;">Kolay</button>
            </div>
        </div>
    </div>
    <audio id="audio-player"></audio>

    <script>
        const sentenceEl = document.getElementById('sentence');
        const promptEl = document.getElementById('prompt');
        const optionsContainerEl = document.getElementById('options-container');
        const statsEl = document.getElementById('stats');
        const speakBtn = document.getElementById('speak-btn');
        const audioPlayer = document.getElementById('audio-player');
        const resetBtn = document.getElementById('reset-btn');
        const srsControlsEl = document.getElementById('srs-controls');
        const srsAgainBtn = document.getElementById('srs-again');
        const srsHardBtn = document.getElementById('srs-hard');
        const srsGoodBtn = document.getElementById('srs-good');
        const srsEasyBtn = document.getElementById('srs-easy');
        const quizContainer = document.querySelector('.quiz-container');
        const statusLabel = document.getElementById('question-status');

        const downloadProgressBtn = document.getElementById('download-progress-btn');
        const uploadProgressBtn = document.getElementById('upload-progress-btn');
        const uploadProgressInput = document.getElementById('upload-progress-input');

        const DAILY_NEW_QUESTION_LIMIT = 200;
        
        let dueQuestionsPool = [];
        let allQuestions = [];
        let answered = false;
        let currentQuestion = null;
        const srsIntervals = [1, 3, 7, 15, 30, 60, 120, 240, 360];

        async function startQuiz() {
            try {
                // EÄŸer progress.json varsa onu yÃ¼kle
                try {
                    const progressRes = await fetch('./progress.json');
                    if (progressRes.ok) {
                        const progressData = await progressRes.json();
                        localStorage.setItem('questionStates', JSON.stringify(progressData.questionStates || {}));
                        localStorage.setItem('dailyStats', JSON.stringify(progressData.dailyStats || {}));
                    }
                } catch(e) {}

                if (allQuestions.length === 0) {
                    const response = await fetch('./soru_bankasi.json');
                    if (!response.ok) throw new Error('Hata: soru_bankasi.json dosyasÄ± yÃ¼klenemedi.');
                    const loadedData = await response.json();
                    allQuestions = loadedData.flatMap(wordData =>
                        wordData.questions.map(q => ({ ...q, word: wordData.word }))
                    );
                }

                const states = JSON.parse(localStorage.getItem('questionStates') || '{}');
                const todayStr = new Date().toISOString().split('T')[0];
                let dailyStats = JSON.parse(localStorage.getItem('dailyStats') || '{}');
                if (dailyStats.date !== todayStr) {
                    dailyStats = { date: todayStr, newQuestionsSeen: 0 };
                    localStorage.setItem('dailyStats', JSON.stringify(dailyStats));
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const reviewQuestions = [];
                const newQuestions = [];
                for (const q of allQuestions) {
                    const state = states[q.questionId];
                    if (state && state.dueDate) {
                        const dueDate = new Date(state.dueDate);
                        if (dueDate <= today) reviewQuestions.push(q);
                    } else if (!state) {
                        newQuestions.push(q);
                    }
                }
                
                const newQuestionsAllowedToday = DAILY_NEW_QUESTION_LIMIT - dailyStats.newQuestionsSeen;
                const newQuestionsForSession = newQuestions.slice(0, Math.max(0, newQuestionsAllowedToday));
                
                dueQuestionsPool = [...reviewQuestions, ...newQuestionsForSession];

                if (dueQuestionsPool.length === 0 && allQuestions.length > 0) {
                    displayNoMoreQuestionsMessage(states);
                    return;
                }

                dueQuestionsPool.sort(() => Math.random() - 0.5);
                displayQuestion();

            } catch (error) {
                quizContainer.innerHTML = `<h1>Hata</h1><p>${error.message}</p>`;
            }
        }
        
        function displayQuestion() {
            if (dueQuestionsPool.length === 0) { startQuiz(); return; }
            answered = false;
            srsControlsEl.style.display = 'none';
            updateStats();
            currentQuestion = dueQuestionsPool[0];

            const states = JSON.parse(localStorage.getItem('questionStates') || '{}');
            const isNew = !states[currentQuestion.questionId];
            if(isNew) {
                statusLabel.textContent = 'YENÄ°';
                statusLabel.className = 'status-label status-new';
            } else {
                statusLabel.textContent = 'ESKÄ°';
                statusLabel.className = 'status-label status-review';
            }
            
            audioPlayer.src = `./audio/${currentQuestion.questionId}.mp3`;
            sentenceEl.innerHTML = currentQuestion.sentence.replace(/\[__.*?__\]/g, `<b>[_______]</b>`);
            promptEl.textContent = currentQuestion.prompt;
            optionsContainerEl.innerHTML = '';
            const options = currentQuestion.options;
            let optionKeys = Object.keys(options).sort(() => Math.random() - 0.5);
            for (const key of optionKeys) {
                const optionEl = document.createElement('div');
                optionEl.classList.add('option');
                optionEl.dataset.key = key;
                optionEl.innerHTML = `<span class="option-letter">${key.toUpperCase()}</span><span>${options[key]}</span>`;
                optionEl.addEventListener('click', () => selectAnswer(optionEl, key));
                optionsContainerEl.appendChild(optionEl);
            }
        }

        function selectAnswer(selectedOptionEl, selectedKey) {
            if (answered) return;
            answered = true;
            const correctKey = currentQuestion.correctAnswer;
            Array.from(optionsContainerEl.children).forEach(option => {
                option.style.cursor = 'default';
                if (option.dataset.key === correctKey) option.classList.add('correct');
                else if (option.dataset.key === selectedKey) option.classList.add('incorrect');
            });
            updateSrsButtonLabels(selectedKey === correctKey);
            srsControlsEl.style.display = 'flex';
        }
        
        function formatInterval(days) {
            if (!days || days < 1) return `~10dk`;
            if (days < 30) return `${days}g`;
            const months = Math.round(days / 30);
            return `~${months}ay`;
        }

        function updateSrsButtonLabels(isCorrect) {
            const states = JSON.parse(localStorage.getItem('questionStates') || '{}');
            const state = states[currentQuestion.questionId] || { level: 0 };
            const currentLevel = state.level;

            srsAgainBtn.style.display = 'block';
            srsAgainBtn.textContent = `Tekrar (${formatInterval(0)})`;

            if (!isCorrect) {
                srsHardBtn.style.display = 'none';
                srsGoodBtn.style.display = 'none';
                srsEasyBtn.style.display = 'none';
            } else {
                srsHardBtn.style.display = 'block';
                srsGoodBtn.style.display = 'block';
                srsEasyBtn.style.display = 'block';
                
                const hardInterval = srsIntervals[Math.min(currentLevel, srsIntervals.length - 1)];
                srsHardBtn.textContent = `Zor (${formatInterval(hardInterval)})`;

                const goodLevel = currentLevel + 1;
                const goodInterval = srsIntervals[Math.min(goodLevel, srsIntervals.length - 1)];
                srsGoodBtn.textContent = `Ä°yi (${formatInterval(goodInterval)})`;

                const easyLevel = currentLevel + 2;
                const easyInterval = srsIntervals[Math.min(easyLevel, srsIntervals.length - 1)];
                srsEasyBtn.textContent = `Kolay (${formatInterval(easyInterval)})`;
            }
        }
        
        function updateStats() {
            const states = JSON.parse(localStorage.getItem('questionStates') || '{}');
            const todayStr = new Date().toISOString().split('T')[0];
            let dailyStats = JSON.parse(localStorage.getItem('dailyStats') || `{ "date": "${todayStr}", "newQuestionsSeen": 0 }`);
            if (dailyStats.date !== todayStr) dailyStats.newQuestionsSeen = 0;
            const knownCount = Object.keys(states).filter(id => states[id] && states[id].level > 0).length;
            statsEl.innerHTML = `BugÃ¼n Kalan: ${dueQuestionsPool.length}<br>Yeni: ${dailyStats.newQuestionsSeen}/${DAILY_NEW_QUESTION_LIMIT}<br>Ã–ÄŸrenilen: ${knownCount}/${allQuestions.length || '...'}`;
        }

        function displayNoMoreQuestionsMessage(questionStates) {
            let nextQuestionDate = null;
            const today = new Date();
            today.setHours(0,0,0,0);
            for (const qId in questionStates) {
                if (questionStates[qId].dueDate) {
                    const dueDate = new Date(questionStates[qId].dueDate);
                    if (dueDate > today && (!nextQuestionDate || dueDate < nextQuestionDate)) {
                        nextQuestionDate = dueDate;
                    }
                }
            }
            let message = `<h1>Harika!</h1><p>BugÃ¼nlÃ¼k tÃ¼m sorularÄ± tamamladÄ±nÄ±z.</p>`;
            if (nextQuestionDate) {
                const formattedDate = nextQuestionDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                message += `<p style='font-size:0.9em'>Bir sonraki tekrar oturumunuz <b>${formattedDate}</b> tarihinde.</p>`;
            }
            message += `<button id="final-reset-btn" style="margin-top: 15px;">TÃ¼m Ä°lerlemeyi SÄ±fÄ±rla</button>`;
            quizContainer.innerHTML = message;
            document.getElementById('final-reset-btn').addEventListener('click', resetProgress);
        }

        function updateQuestionState(rating) {
            const states = JSON.parse(localStorage.getItem('questionStates') || '{}');
            const questionId = currentQuestion.questionId;
            const isNewQuestion = !states[questionId];
            let currentState = states[questionId] || { level: 0 };

            if (isNewQuestion && rating !== 'again') {
                const todayStr = new Date().toISOString().split('T')[0];
                let dailyStats = JSON.parse(localStorage.getItem('dailyStats') || `{ "date": "${todayStr}", "newQuestionsSeen": 0 }`);
                if (dailyStats.date !== todayStr) {
                    dailyStats = { date: todayStr, newQuestionsSeen: 1 };
                } else {
                    dailyStats.newQuestionsSeen++;
                }
                localStorage.setItem('dailyStats', JSON.stringify(dailyStats));
            }
            
            let nextDueDate = new Date();
            nextDueDate.setHours(0,0,0,0);

            if (rating === 'again') {
                currentState.level = 0;
                const reInsertIndex = Math.min(10, dueQuestionsPool.length);
                dueQuestionsPool.splice(reInsertIndex, 0, currentQuestion);
            } else {
                if (rating === 'hard') currentState.level = Math.max(0, currentState.level);
                else if (rating === 'good') currentState.level++;
                else if (rating === 'easy') currentState.level += 2;
                
                const intervalIndex = Math.min(currentState.level, srsIntervals.length - 1);
                const intervalDays = srsIntervals[intervalIndex] || 1;
                nextDueDate.setDate(nextDueDate.getDate() + intervalDays);
                currentState.dueDate = nextDueDate.toISOString().split('T')[0];
            }
           
            states[questionId] = currentState;
            localStorage.setItem('questionStates', JSON.stringify(states));
            
            dueQuestionsPool.shift();
            displayQuestion();
        }

        function resetProgress() {
            if (confirm("TÃ¼m Ã¶ÄŸrenme ilerlemeniz ve istatistikleriniz silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?")) {
                localStorage.removeItem('questionStates');
                localStorage.removeItem('dailyStats');
                location.reload();
            }
        }

        // Ä°lerlemeyi indir
        function downloadProgress() {
            const data = {
                questionStates: JSON.parse(localStorage.getItem('questionStates') || '{}'),
                dailyStats: JSON.parse(localStorage.getItem('dailyStats') || '{}')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "progress.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        // Ä°lerlemeyi yÃ¼kle
        function uploadProgress(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.questionStates) {
                        localStorage.setItem('questionStates', JSON.stringify(data.questionStates));
                    }
                    if (data.dailyStats) {
                        localStorage.setItem('dailyStats', JSON.stringify(data.dailyStats));
                    }
                    alert("Ä°lerleme baÅŸarÄ±yla yÃ¼klendi!");
                    location.reload();
                } catch (err) {
                    alert("GeÃ§ersiz dosya formatÄ±!");
                }
            };
            reader.readAsText(file);
        }

        // Buton event listener'larÄ±
        resetBtn.addEventListener('click', resetProgress);
        downloadProgressBtn.addEventListener('click', downloadProgress);
        uploadProgressBtn.addEventListener('click', () => uploadProgressInput.click());
        uploadProgressInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadProgress(e.target.files[0]);
            }
        });

        speakBtn.addEventListener('click', () => {
            if (currentQuestion && audioPlayer.src) {
                audioPlayer.play().catch(error => {
                    console.error("Ses Ã§alma hatasÄ±:", error);
                });
            }
        });

        srsAgainBtn.addEventListener('click', () => updateQuestionState('again'));
        srsHardBtn.addEventListener('click', () => updateQuestionState('hard'));
        srsGoodBtn.addEventListener('click', () => updateQuestionState('good'));
        srsEasyBtn.addEventListener('click', () => updateQuestionState('easy'));
        
        // BaÅŸlat
        startQuiz();
    </script>
</body>
</html>
